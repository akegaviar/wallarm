.. _installation-nginx-ru:

====================================================
Установите динамически подключаемый модуль для NGINX
====================================================
 
Если в вашей системе уже установлен NGINX, то вместо модуля NGINX-Wallarm
вы можете подключить динамический модуль nginx-module-wallarm.

Ограниченная поддержка динамически подключаемого модуля NGINX
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Поддержка динамических модулей в NGINX имеет ограничение: скомпилированный
модуль совместим только с той версией NGINX и тем набором опций компиляции,
например, поддержка IPv6, HTTPv2 и т.п., с которыми он был собран.

Если вы собираете NGINX самостоятельно, то динамический модуль из репозитория
Wallarm может не подойти и не загрузиться. Для пересборки динамического модуля
обратитесь в `техническую поддержку <https://my.wallarm.com>`_. При обращении
предоставьте результат выполнения команды:

* `официальная сборка NGINX <http://nginx.org/en/linux_packages.html>`_: :command:`/usr/sbin/nginx -V`
* специальная сборка NGINX: команда как :command:`<path to nginx>/nginx -v`

Варианты установки
~~~~~~~~~~~~~~~~~~

.. include:: /ru/include-ru/installation-options-ru.rst

Если вы планируете установить модуль постаналитики на отдельный сервер,
необходимо сначала установить его. :ref:`ТТК` installing-post-analytics-on-a-separate-server-pool.md

Для установки динамически подключаемого модуля для NGINX вам потребуется
выполнить следующие действия:

#. Установить NGINX.
#. Добавить репозитории Wallarm, из которых вы загрузите пакеты.
#. Установить пакеты Wallarm.
#. Настроить модуль постаналитики.
#. Подключить модуль NGINX-Wallarm.
#. Установить лицензионный ключ.
#. Настроить триггер для обновления правил фильтрации.
#. Подключить фильтрующий узел к облаку Wallarm.
#. Настроить адреса сервера постаналитики.
#. Настроить режим фильтрации.

Установите NGINX
~~~~~~~~~~~~~~~~

Вы можете:

* использовать `официальную сборку <http://nginx.org/en/linux_packages.html>`_
* собрать самостоятельно с аналогичными опциями компиляции.

`Официальная инструкция по установке NGINX <https://www.nginx.com/resources/admin-guide/installing-nginx-open-source/>`_.

Добавьте репозитории Wallarm
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Установка и обновление модуля NGINX-Wallarm происходит из репозиториев Wallarm.

В зависимости от вашей операционной системы, выполните одну из следующих команд:

.. include:: /ru/include-ru/add-repo-ru.rst

.. include:: /ru/include-ru/access-repo-ru.rst

Установите пакеты Wallarm
~~~~~~~~~~~~~~~~~~~~~~~~~

Для выполнения обработки запросов и постаналитики на одном сервере необходимо
установить следующие пакеты:

* модуль NGINX-Wallarm
* располагающееся в памяти хранилище Tarantool
* локальные аналитические скрипты

Для выполнения только обработки запросов на сервере необходимо
установить следующие пакеты:

* модуль NGINX-Wallarm

Установите обработку запросов и постаналитику на один сервер
------------------------------------------------------------

.. include:: /ru/include-ru/install-nginx-postanalytics-ru.rst

Установите только обработку запросов на сервер
----------------------------------------------

.. include:: /ru/include-ru/install-nginx-ru.rst

Настройте модуль постаналитики
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: Пропустите этот шаг, если постаналитика установлена на отдельный
          сервер.

.. include:: /ru/include-ru/configure-postanalytics-ru.rst

Подключите модуль NGINX-Wallarm
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Добавьте в файл ``/etc/nginx/nginx.conf`` следующую директиву:

.. code-block:: ini

   load_module modules/ngx_http_wallarm_module.so;

Скопируйте конфигурационные файлы для настройки системы:

.. code-block:: command

   cp /usr/share/doc/nginx-module-wallarm/examples/*.conf /etc/nginx/conf.d/

Установите лицензионный ключ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /ru/include-ru/install-license-ru.rst

Настройте триггер для обновления правил фильтрации
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Wallarm автоматически загружает правила фильтрации. Для применения загруженных
правил Wallarm также автоматически перезапускает NGINX.

Если вы используете NGINX специальной сборки, Wallarm может не иметь
возможность автоматически перезапустить NGINX.

.. note:: Пропустите текущий шаг, если используемый вами NGINX можно
          перезапустить одной из следующих команд:
          
           * :command:`service nginx reload`
           * :command:`invoke-rc.d nginx reload`
           * :command:`systemctl reload nginx`

Если перечисленные команды не перезапускают NGINX, в файле триггера обновления
``/etc/wallarm/triggers.d/nginx`` измените перезапуска, указав новую после
приведенного ниже фрагмента:

.. include:: /ru/include-ru/restart-nginx-ru.rst

Подключите фильтрующий узел к облаку Wallarm
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /ru/include-ru/connect-cloud-ru.rst

Настройте адреса сервера постаналитики
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note:: Пропустите этот шаг, если постаналитика установлена на отдельный
          сервер.

.. include:: /ru/include-ru/configure-postanalytics-address-ru.rst

Настройте режим фильтрации
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /ru/include-ru/setup-filter-ru.rst

На этом установка завершена.

.. include:: /ru/include-ru/check-setup-installation-ru.rst